<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Wave Precision</title>

    <style>
        body {
            margin: 0;
            background: #05070f;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            color: white;
            font-family: Arial, sans-serif;
        }

        canvas {
            background: #0b1020;
            border: 2px solid #202b55;
        }

        .ui {
            position: absolute;
            top: 12px;
            left: 12px;
            font-size: 18px;
            opacity: 0.9;
        }
    </style>
</head>

<body>

    <div class="ui">
        Score: <span id="score">0</span>
    </div>

    <canvas id="game" width="900" height="500"></canvas>

    <script>
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('score');

        // ─────────────────────────────
        // IMAGE
        // ─────────────────────────────
        const waveImage = new Image();
        waveImage.src = 'wave.png';

        // ─────────────────────────────
        // PLAYER
        // ─────────────────────────────
        const player = {
            x: 180,
            y: canvas.height / 2,
            size: 28,
            speed: 4,
            direction: 1, // 1 = up, -1 = down
            trail: []
        };

        // ─────────────────────────────
        // COULOIR
        // ─────────────────────────────
        let gap = 90;
        let centerY = canvas.height / 2;
        let corridorDir = 1;

        let topPath = [];
        let bottomPath = [];

        const scrollSpeed = 3;

        // ─────────────────────────────
        // GAME STATE
        // ─────────────────────────────
        let running = false;
        let score = 0;
        let deathTimeout = null;

        // ─────────────────────────────
        // INPUT
        // ─────────────────────────────
        window.addEventListener('mousedown', () => player.direction = -1);
        window.addEventListener('mouseup', () => player.direction = 1);

        window.addEventListener('keydown', e => {
            if (e.code === 'Space') player.direction = -1;
        });
        window.addEventListener('keyup', e => {
            if (e.code === 'Space') player.direction = 1;
        });

        // ─────────────────────────────
        // START / RESET
        // ─────────────────────────────
        function startGame() {
            running = true;
            score = 0;
            scoreEl.textContent = 0;

            player.y = canvas.height / 2;
            player.trail = [];

            centerY = canvas.height / 2;
            corridorDir = 1;

            topPath = [];
            bottomPath = [];

            for (let x = canvas.width; x >= -50; x -= 10) {
                topPath.push({ x, y: centerY - gap / 2 });
                bottomPath.push({ x, y: centerY + gap / 2 });
            }

            requestAnimationFrame(loop);
        }

        // ─────────────────────────────
        // UPDATE
        // ─────────────────────────────
        function update() {
            if (!running) return;

            // wave movement
            player.y += player.direction * player.speed;

            // trail
            player.trail.push({ x: player.x, y: player.y });
            if (player.trail.length > 20) player.trail.shift();

            // corridor vertical movement (same slope)
            centerY += corridorDir * player.speed;

            if (centerY - gap / 2 < 50) corridorDir = 1;
            if (centerY + gap / 2 > canvas.height - 50) corridorDir = -1;

            // move corridor
            topPath.forEach(p => p.x -= scrollSpeed);
            bottomPath.forEach(p => p.x -= scrollSpeed);

            // extend corridor
            while (topPath[topPath.length - 1].x < canvas.width) {
                const nextX = topPath[topPath.length - 1].x + 10;
                topPath.push({ x: nextX, y: centerY - gap / 2 });
                bottomPath.push({ x: nextX, y: centerY + gap / 2 });
            }

            // cleanup
            topPath = topPath.filter(p => p.x > -30);
            bottomPath = bottomPath.filter(p => p.x > -30);

            // collision
            for (let i = 0; i < topPath.length; i++) {
                if (Math.abs(topPath[i].x - player.x) < 6) {
                    if (
                        player.y < topPath[i].y ||
                        player.y > bottomPath[i].y
                    ) {
                        die();
                        return;
                    }
                }
            }

            score++;
            scoreEl.textContent = score;
        }

        // ─────────────────────────────
        // DRAW
        // ─────────────────────────────
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // corridor
            ctx.strokeStyle = '#ff3b3b';
            ctx.lineWidth = 2;

            ctx.beginPath();
            topPath.forEach((p, i) => i === 0 ? ctx.moveTo(p.x, p.y) : ctx.lineTo(p.x, p.y));
            ctx.stroke();

            ctx.beginPath();
            bottomPath.forEach((p, i) => i === 0 ? ctx.moveTo(p.x, p.y) : ctx.lineTo(p.x, p.y));
            ctx.stroke();

            // trail
            ctx.strokeStyle = 'rgba(0, 234, 255, 0.5)';
            ctx.lineWidth = 3;
            ctx.beginPath();
            player.trail.forEach((p, i) => i === 0 ? ctx.moveTo(p.x, p.y) : ctx.lineTo(p.x, p.y));
            ctx.stroke();

            // wave image with rotation
            const angle = player.direction === -1 ? -Math.PI / 4 : Math.PI / 4;

            ctx.save();
            ctx.translate(player.x, player.y);
            ctx.rotate(angle);
            ctx.drawImage(
                waveImage,
                -player.size / 2,
                -player.size / 2,
                player.size,
                player.size
            );
            ctx.restore();
        }

        // ─────────────────────────────
        // DEATH
        // ─────────────────────────────
        function die() {
            running = false;

            if (deathTimeout) clearTimeout(deathTimeout);
            deathTimeout = setTimeout(startGame, 500);
        }

        // ─────────────────────────────
        // LOOP
        // ─────────────────────────────
        function loop() {
            update();
            draw();

            if (running) {
                requestAnimationFrame(loop);
            }
        }

        // ─────────────────────────────
        // INIT
        // ─────────────────────────────
        waveImage.onload = startGame;
    </script>

</body>

</html>