<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Soumettre un niveau - SV CHALLENGE LIST</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="submission.css">
    <link rel="stylesheet" href="dark-mode.css">
    <link rel="stylesheet" href="mobile-optimized.css">
    <!-- Supabase Storage (Supabase + localStorage fallback) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="storage-adapter.js"></script>
    <script src="supabase-config.js"></script>
    <script>
        // Client Supabase pour l'authentification
        let submissionClient;

        // Initialiser Supabase PUIS le stockage (en sÃ©quence)
        console.log('ğŸ”„ Initialisation du stockage (submission)...');

        async function initializeSubmission() {
            try {
                // D'abord activer Supabase (charge la lib et initialise le client)
                await enableSupabaseStorage();
                console.log('âœ… Supabase activÃ© et client initialisÃ©');

                // Puis initialiser le stockage avec le client global
                await initializeSupabaseStorage();
                console.log('âœ… Stockage prÃªt (submission)');

                // Initialiser le client d'authentification
                submissionClient = window.supabaseClient;
                window.submissionClient = submissionClient;
            } catch (err) {
                console.error('âŒ Erreur initialisation stockage:', err.message);
                throw err;
            }
        }

        async function checkUserSession() {
            // Attendre que submissionClient soit initialisÃ©
            let attempts = 0;
            while (!window.submissionClient && attempts < 100) {
                await new Promise(resolve => setTimeout(resolve, 50));
                attempts++;
            }

            if (!window.submissionClient) {
                console.error('âŒ submissionClient non initialisÃ©');
                showLoginRequired();
                return;
            }

            const { data: { session } } = await window.submissionClient.auth.getSession();

            if (!session) {
                console.log('âŒ Pas de session utilisateur');
                showLoginRequired();
            } else {
                console.log('âœ… Utilisateur connectÃ©:', session.user.email);
            }
        }

        function showLoginRequired() {
            const formContainer = document.querySelector('.submission-wrapper');
            if (formContainer) {
                formContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <h2>ğŸ”’ Connexion requise</h2>
                        <p style="margin: 20px 0;">Vous devez Ãªtre connectÃ© pour soumettre un niveau.</p>
                        <a href="auth.html" class="btn-submit" style="display: inline-block; text-decoration: none;">
                            Se connecter / S'inscrire
                        </a>
                    </div>
                `;
            }
        }

        // Lancer l'initialisation
        initializeSubmission();
    </script>
</head>

<body>
    <header>
        <div class="header-content">
            <h1>SV CHALLENGE LIST</h1>
            <div class="header-links">
                <a href="index.html">â† Retour Ã  la liste</a>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <div class="submission-wrapper">
                <h2>ğŸ“ Soumettre un nouveau niveau</h2>

                <form id="submissionForm" class="submission-form">
                    <div class="form-group">
                        <label for="levelName">Nom du niveau *</label>
                        <input type="text" id="levelName" name="levelName" placeholder="Ex: SV Kawai" required>
                    </div>

                    <div class="form-group">
                        <label for="levelId">ID du niveau *</label>
                        <input type="text" id="levelId" name="levelId" placeholder="Ex: 12345678" required>
                        <small>L'identifiant unique du niveau dans Geometry Dash</small>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="creatorName">CrÃ©ateur du niveau *</label>
                            <input type="text" id="creatorName" name="creatorName" placeholder="CrÃ©ateur" required>
                        </div>

                        <div class="form-group">
                            <label for="authorName">Auteur du record *</label>
                            <input type="text" id="authorName" name="authorName" placeholder="Votre pseudo" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="playerCountry">Pays *</label>
                            <select id="playerCountry" name="playerCountry" required>
                                <option value="">SÃ©lectionner...</option>
                                <option value="France">ğŸ‡«ğŸ‡· France</option>
                                <option value="Belgique">ğŸ‡§ğŸ‡ª Belgique</option>
                                <option value="Suisse">ğŸ‡¨ğŸ‡­ Suisse</option>
                                <option value="Canada">ğŸ‡¨ğŸ‡¦ Canada</option>
                                <option value="Luxembourg">ğŸ‡±ğŸ‡º Luxembourg</option>
                                <option value="Autre">ğŸŒ Autre</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="playerRegion">RÃ©gion</label>
                            <input type="text" id="playerRegion" name="playerRegion"
                                placeholder="Ex: Ãle-de-France, QuÃ©bec...">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="length">Longueur *</label>
                            <select id="length" name="length" required>
                                <option value="">SÃ©lectionner...</option>
                                <option value="Tiny">Tiny</option>
                                <option value="Short">Short</option>
                                <option value="Medium">Medium</option>
                                <option value="Long">Long</option>
                                <option value="XL">XL</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="proposedTop">Top proposÃ© *</label>
                        <input type="number" id="proposedTop" name="proposedTop" placeholder="Ex: 1, 5, 10..." min="1"
                            required>
                    </div>

                    <div class="form-group">
                        <label>Tags (caractÃ©ristiques du niveau)</label>
                        <div class="tags-container">
                            <label class="tag-label wave">
                                <input type="checkbox" name="tags" value="wave">
                                <span class="tag-text">ğŸŒŠ wave</span>
                            </label>
                            <label class="tag-label ship">
                                <input type="checkbox" name="tags" value="ship">
                                <span class="tag-text">ğŸš€ ship</span>
                            </label>
                            <label class="tag-label overall">
                                <input type="checkbox" name="tags" value="overall">
                                <span class="tag-text">ğŸ¯ overall</span>
                            </label>
                            <label class="tag-label timing">
                                <input type="checkbox" name="tags" value="timing">
                                <span class="tag-text">â±ï¸ timing</span>
                            </label>
                            <label class="tag-label vitesse">
                                <input type="checkbox" name="tags" value="vitesse">
                                <span class="tag-text">âš¡ vitesse</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="youtubeLink">Lien YouTube de la vÃ©rification *</label>
                        <input type="url" id="youtubeLink" name="youtubeLink"
                            placeholder="https://www.youtube.com/watch?v=..." required>
                        <small>Lien vers votre vidÃ©o YouTube montrant le niveau complÃ©tÃ©</small>
                    </div>

                    <div class="form-group">
                        <label for="levelImage">Image du niveau *</label>
                        <input type="file" id="levelImage" name="levelImage" accept="image/*" required>
                        <small>Formats acceptÃ©s: JPG, PNG, GIF (max 5MB)</small>
                    </div>

                    <div class="form-group">
                        <label for="description">Description/Commentaires</label>
                        <textarea id="description" name="description" placeholder="Ajoute des dÃ©tails sur ce niveau..."
                            rows="4"></textarea>
                    </div>

                    <button type="submit" class="btn-submit">ğŸ“¤ Soumettre le niveau</button>
                </form>

                <div id="successMessage" class="success-message hidden">
                    âœ… Niveau soumis avec succÃ¨s ! L'admin examinera votre soumission.
                </div>

                <div id="errorMessage" class="error-message hidden"></div>
            </div>
        </div>
    </main>

    <footer>
        <p>SV Challenge List - CrÃ©Ã© par Spleen</p>
    </footer>

    <script src="submission.js"></script>
    <script src="submit-handler.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸ“ Submission: DOMContentLoaded appelÃ©');

            // Attendre que le stockage ET submissionClient soient initialisÃ©s
            let attempts = 0;
            while ((!universalStorage || !window.submissionClient) && attempts < 100) {
                await new Promise(resolve => setTimeout(resolve, 50));
                attempts++;
            }

            if (!universalStorage) {
                console.error('âš ï¸ Stockage non initialisÃ©, utilisÃ© fallback');
            } else {
                console.log('âœ… Stockage prÃªt (', universalStorage.getCurrentAdapter(), ')');
            }

            // VÃ©rifier la session utilisateur une fois le DOM chargÃ©
            await checkUserSession();
        });
    </script>
    <script src="dark-mode.js"></script>
</body>

</html>